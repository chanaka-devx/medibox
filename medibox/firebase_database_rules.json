{
  "rules": {
    "users": {
      "$userId": {
        ".read": "$userId === auth.uid",
        ".write": "$userId === auth.uid",
        "email": {
          ".validate": "newData.isString()"
        },
        "displayName": {
          ".validate": "newData.isString() && newData.val().length >= 2"
        },
        "phoneNumber": {
          ".validate": "newData.isString() && newData.val().length >= 10"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        "devices": {
          ".validate": "newData.isString() || (newData.hasChildren() && newData.val() is List)"
        }
      }
    },
    "devices": {
      "$deviceId": {
        ".read": "root.child('users').child(auth.uid).child('devices').val().contains($deviceId)",
        ".write": "root.child('users').child(auth.uid).child('devices').val().contains($deviceId)",
        "nickname": {
          ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 50"
        },
        "schedule": {
          ".validate": "newData.hasChildren(['morning', 'afternoon', 'night'])",
          "morning": {
            ".validate": "newData.isString() && newData.val().matches(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/)"
          },
          "afternoon": {
            ".validate": "newData.isString() && newData.val().matches(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/)"
          },
          "night": {
            ".validate": "newData.isString() && newData.val().matches(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/)"
          }
        },
        "status": {
          "online": {
            ".validate": "newData.isBoolean()"
          },
          "lastDispensed": {
            ".validate": "newData.isString()"
          },
          "lastSyncTime": {
            ".validate": "newData.isString()"
          },
          "batteryLevel": {
            ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100"
          }
        },
        "alerts": {
          "missedDose": {
            ".validate": "newData.isBoolean()"
          },
          "missedDoseTime": {
            ".validate": "newData.isString()"
          },
          "deviceOffline": {
            ".validate": "newData.isBoolean()"
          },
          "lowBattery": {
            ".validate": "newData.isBoolean()"
          },
          "message": {
            ".validate": "newData.isString()"
          },
          "timestamp": {
            ".validate": "newData.isString()"
          }
        },
        "manualDispense": {
          ".write": "root.child('users').child(auth.uid).child('devices').val().contains($deviceId)",
          "compartment": {
            ".validate": "newData.isString() && (newData.val() === 'morning' || newData.val() === 'afternoon' || newData.val() === 'night')"
          },
          "timestamp": {
            ".validate": "newData.isString()"
          },
          "triggered": {
            ".validate": "newData.isBoolean()"
          }
        },
        "silenceAlarm": {
          ".write": "root.child('users').child(auth.uid).child('devices').val().contains($deviceId)",
          "silenced": {
            ".validate": "newData.isBoolean()"
          },
          "timestamp": {
            ".validate": "newData.isString()"
          }
        },
        "addedDate": {
          ".validate": "newData.isString()"
        }
      }
    }
  }
}
